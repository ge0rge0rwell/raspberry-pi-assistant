name: Build Nova OS Image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Nova OS Image via Docker
        run: |
          docker run --privileged --rm \
            -v "$(pwd):/repo" \
            -e IMG_NAME="NovaOS" \
            debian:bookworm /bin/bash -c "
              apt-get update && apt-get install -y \
                git quilt parted realpath qemu-user-static debootstrap \
                zerofree zip dosfstools libarchive-tools libcap2-bin \
                grep rsync xz-utils file curl bc sudo kpartx
              
              git clone --depth 1 https://github.com/RPi-Distro/pi-gen.git /pi-gen
              cd /pi-gen
              
              # Add Nova OS Layer
              mkdir -p stage2/01-nova-os/files/home/pi/offline_assistant
              # Copy project files into the layer's rootfs path
              cp -r /repo/src stage2/01-nova-os/files/home/pi/offline_assistant/
              cp -r /repo/gui stage2/01-nova-os/files/home/pi/offline_assistant/
              cp -r /repo/scripts stage2/01-nova-os/files/home/pi/offline_assistant/
              cp /repo/package.json stage2/01-nova-os/files/home/pi/offline_assistant/ || true
              
              # Create the installation script (runs inside chroot)
              echo '        
              #!/bin/bash
              set -e
              chown -R 1000:1000 /home/pi/offline_assistant
              cd /home/pi/offline_assistant/scripts
              chmod +x *.sh
              # Run setup (ignore failures for services that cant start in chroot)
              ./setup.sh || true
              ./kiosk_setup.sh || true
              ' > stage2/01-nova-os/01-run.sh
              chmod +x stage2/01-nova-os/01-run.sh
              
              # Configuration
              echo \"IMG_NAME='NovaOS'\" > config
              echo \"RELEASE='bookworm'\" >> config
              echo \"DEPLOY_ZIP=1\" >> config
              
              # Optimize: Skip stages 3-5 (Desktop, specialized tools)
              touch stage3/SKIP stage4/SKIP stage5/SKIP
              
              ./build.sh
              cp deploy/*.zip /repo/
            "
          
      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: nova-os-image
          path: "*.zip"
